# 功能
## 说明
以下提到的命令均由mqtt客户端下发，本程序（设备端程序），接收并响应mqtt客户端下发的命令，响应的消息通常是尖括号括起来的字符串。如<succ_HYDFv1.0.1>。
## 远程升级方案
该程序运行在设备端，通过中心站（具有公网IP）进行软件升级
设备接收到中心站通过MQTT通道发送的升级指令后，从位于中心站SFTP服务器拉取升级包，之后完成校验、升级。
### 远程升级包
远程升级包应为压缩包，能够一次性升级设备的各个组件。
命名规则：“名称_版本号_md5校验码.bin”
如HSIMup_HYDFv1.0.1_551024b02dc589177715979902dcff89.bin
其中551024b02dc589177715979902dcff89为md5校验码。

### mqtt服务端下发下载和查询升级包指令（DOWNPACK命令+包名）。
示例命令：
DOWNPACK,HSIMup_HYDFv1.0.1_551024b02dc589177715979902dcff89.bin
②mqtt客户端收到指令后，确认指令格式，返回确认值 <START_DOWNLOAD>↙。
③调用SFTP客户端启动下载指定包名的升级包。
④进行升级包下载，下载完成后进行升级包md5校验。
⑤进行升级包zip解压,执行如何里面有update.sh脚本，执行该脚本，如果没有update.sh脚本，则用node执行update.js脚本。
⑥将升级包下载结果通过mqtt客户端上报，下载成功上报版本号例<HYDFv1.0.1>；下载失败或校验不成功，如实以字符串形式返回结果<download_failed>或<check_failed>。

查询当前升级包：
查询设备当前存储的升级包名称，命令为：
DOWNPACK
返回值：有存储的升级包则返回<HSIMup_HYDFv1.0.1_551024b02dc589177715979902dcff89.bin>↙；
无存储的升级包则返回<F>

第二次指令交互：
⑦mqtt服务端下发升级指令（UPGRADE命令+版本号）
例UPGRADE,HYDFv1.0.1
⑧执行升级逻辑，返回升级结果，成功返回<succ_版本号>,例<succ_HYDFv1.0.1>,失败返回失败原因如<No such file or directory>。

查询设备当前软件版本，命令：
UPGRADE
返回值：成功返回当前版本号如: <HYDFv1.0.1>

## 打开SSH服务命令（OPENSSH）（运维mqtt客户端专用）
参数：无；
描述：该功能默认关闭，打开后空闲超时3分钟关闭，断开后关闭。
命令：OPENSSH
返回值： 成功打开返回<IP 端口>,例<49.66.31.120 16050>↙,失败返回<F>


## Linux透传命令（如df  -h）（运维mqtt客户端专用）
参数：无；
描述：该指令透传linux指令，并将指令回显如实返回。
命令：如 df -h
返回值：返回值以单独topic“/ECO_OBSV_LINUX/HSIM/PN”（PN为出厂编号）回复键入指令的回显 
<Filesystem      Size  Used Avail Use% Mounted on
/dev/root        24G   10G   13G  44% /
/dev/mmcblk0p7  126M   13M  107M  11% /oem
/dev/mmcblk0p8   92G  531M   88G   1% /data

## SN查询与修改（SN）（运维mqtt客户端专用）
参数：序列号SN；
查询SN命令：SN
返回值： 返回<G160002025120215321532153215>。

修改SN命令：SN,G160002025120215321532153233
返回值： 若修改成功，则返回修改后的SN<G160002025120215321532153233>，失败返回<F>。

## 出厂编号查询（PN）（运维mqtt客户端专用，仅限查询）
参数：无；
描述：PN规则为HYDF+批号+设备ID，如HYDF20260116001。
查询命令：PN
返回值： 返回<HYDF20260116001>。


## 设置或读取数据上报用的mqtt服务器信息（DASETNET）
参数：设备标识符，主机名或IP地址，端口号。 
示例1：
若设置设备欲连接的主机IP地址为192.168.1.100，端口号为10086，命令为：
DASETNET,192.168.1.100,10086
返回值：<F>表示设置失败，<T>表示设置成功。
示例2：
若设置设备欲连接多个主机需要用逗号将IP地址分割，如主机1的IP地址为192.168.1.100，端口号为10086，主机2的IP地址为192.168.1.101，端口号为10087，命令为：
DASETNET,192.168.1.100,10086,192.168.1.101,10087
返回值：<F>表示设置失败，<T>表示设置成功。
示例3：
读取设备mqtt服务器信息，命令：
DASETNET
返回值：<192.168.1.100,10086>。
多链接正确返回值为<192.168.1.100,10086,192.168.1.101,10087>。


## 设置或读取运维用的mqtt服务器信息（SETNET）
参数：设备标识符，主机名或IP地址，端口号。 
示例1：
若设置设备欲连接的主机IP地址为192.168.1.100，端口号为10086，命令为：
SETNET,192.168.1.100,10086
返回值：<F>表示设置失败，<T>表示设置成功。
示例2：
若设置设备欲连接多个主机需要用逗号将IP地址分割，如主机1的IP地址为192.168.1.100，端口号为10086，主机2的IP地址为192.168.1.101，端口号为10087，命令为：
SETNET,192.168.1.100,10086,192.168.1.101,10087↙
返回值：<F>表示设置失败，<T>表示设置成功。
示例3：
读取设备mqtt服务器信息，命令：
SETNET
返回值：<192.168.1.100,10086>。
多链接正确返回值为<192.168.1.100,10086,192.168.1.101,10087>。

# mqtt topic定义

## 设备回复指令内容的topic为“/ECO_OBSV_REPLY/HSIM/PN”例：
如设备的出厂编号PN为HYDF20260116001，则回复指令内容的Topic名称为：
/ECO_OBSV_REPLY/HSIM/HYDF20260116001
除了 "Linux透传命令" 的回复都通过该topic发送。

## 设备回复Linux指令的内容的topic为“/ECO_OBSV_LINUX/HSIM/PN”例：
如设备的出厂编号PN为HYDF20260116001，则回复指令内容的Topic名称为：
/ECO_OBSV_LINUX/HSIM/HYDF20260116001
只有 "Linux透传命令" 的回复通过该topic发送。